% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/preprocessing.R
\name{build_bp_block}
\alias{build_bp_block}
\title{Build Compositional Block from Bulk Petrology Counts}
\usage{
build_bp_block(
  counts_df,
  mineral_cols = NULL,
  apply_clr = FALSE,
  impute = 1e-06,
  samples_order = NULL,
  min_count_per_sample = 10
)
}
\arguments{
\item{counts_df}{Data frame with columns: sample (character/factor) and
one or more numeric columns containing mineral counts or categorical
mineral names. If categorical (e.g., "Qtz", "Fsp"), function will count
occurrences per sample.}

\item{mineral_cols}{Character vector of column names to use as minerals.
If NULL, uses all columns except 'sample'.}

\item{apply_clr}{Logical, apply CLR transformation? (default: FALSE).
If FALSE, returns simplex (proportions). If TRUE, returns CLR coordinates.}

\item{impute}{Small value to add before CLR to avoid log(0) (default: 1e-6).
Only used if apply_clr = TRUE.}

\item{samples_order}{Optional character vector specifying sample order.}

\item{min_count_per_sample}{Minimum total count per sample (default: 10).
Samples with fewer counts are removed with a warning.}
}
\value{
A list with components:
  \item{BP_mat}{Matrix (N x D) of compositional data (proportions if apply_clr=FALSE,
    CLR coordinates if apply_clr=TRUE)}
  \item{samples}{Character vector of sample names}
  \item{minerals}{Character vector of mineral names}
  \item{total_counts}{Integer vector of total counts per sample}
  \item{is_clr}{Logical, was CLR applied?}
}
\description{
Converts raw mineral counts into compositional data ready for unmixing.
Optionally applies centered log-ratio (CLR) transformation or leaves in
simplex space (proportions).
}
\details{
If counts_df has one row per grain (long format), function will aggregate by sample.
If counts_df has one row per sample with counts in columns (wide format), uses directly.

CLR transformation: clr(x) = log(x) - mean(log(x))
Converts from D-1 dimensional simplex to D-dimensional Euclidean space.
}
\examples{
\dontrun{
# Example 1: Long format (one row per grain)
bp_raw <- data.frame(
  sample = rep(c("S1", "S2", "S3"), c(200, 180, 220)),
  mineral = sample(c("Qtz", "Fsp", "Lith", "Musc"), 600, replace = TRUE,
                  prob = c(0.4, 0.3, 0.2, 0.1))
)

bp_block <- build_bp_block(
  counts_df = bp_raw,
  mineral_cols = "mineral",  # column with mineral names
  apply_clr = FALSE  # keep as proportions
)

# Example 2: Wide format (one row per sample, counts in columns)
bp_wide <- data.frame(
  sample = c("S1", "S2", "S3"),
  Qtz = c(80, 70, 90),
  Fsp = c(60, 55, 65),
  Lith = c(40, 35, 45),
  Musc = c(20, 20, 20)
)

bp_block <- build_bp_block(
  counts_df = bp_wide,
  mineral_cols = c("Qtz", "Fsp", "Lith", "Musc"),
  apply_clr = TRUE  # transform to CLR
)

# Use in provenance_unmix
result <- provenance_unmix(
  data_list = list(DZ = dz_mat, BP = bp_block$BP_mat),
  data_types = c(DZ = "continuous", 
                 BP = ifelse(bp_block$is_clr, "clr", "compositional")),
  K = 3
)
}

}
